@php
$configData = Helper::appClasses();
@endphp

@extends('layouts/layoutMaster')

@section('title', 'Catálogo de Exámenes')

@section('vendor-style')
<link rel="stylesheet" href="{{asset('assets/vendor/libs/datatables-bs5/datatables.bootstrap5.css')}}">
<link rel="stylesheet" href="{{asset('assets/vendor/libs/select2/select2.css')}}">
@endsection

@section('vendor-script')
<script src="{{asset('assets/vendor/libs/datatables-bs5/datatables-bootstrap5.js')}}"></script>
<script src="{{asset('assets/vendor/libs/select2/select2.js')}}"></script>
@endsection

@section('content')
<div class="row">
    <div class="col-12">
        <h4 class="fw-bold py-3 mb-4">
            <span class="text-muted fw-light">Laboratorio /</span> Catálogo de Exámenes
        </h4>
    </div>
</div>

<div class="row">
    <!-- Categorías -->
    <div class="col-md-3 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">Categorías</h6>
                <button class="btn btn-xs btn-primary" id="btnNuevaCategoria">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>
            <div class="card-body">
                <ul class="list-group list-group-flush" id="listaCategorias">
                    @foreach($categories as $category)
                    <li class="list-group-item d-flex justify-content-between align-items-center px-0 py-2 category-item" 
                        data-id="{{ $category->id }}" style="cursor: pointer;">
                        <div>
                            <i class="fa-solid fa-folder me-2 text-primary"></i>
                            {{ $category->nombre }}
                        </div>
                        <span class="badge bg-label-primary rounded-pill">{{ $category->exams->count() }}</span>
                    </li>
                    @endforeach
                    @if($categories->count() == 0)
                    <li class="list-group-item text-center text-muted">
                        <small>No hay categorías</small>
                    </li>
                    @endif
                </ul>
                <button class="btn btn-sm btn-outline-primary w-100 mt-3" id="btnVerTodos">
                    <i class="fa-solid fa-list me-1"></i>Ver Todos
                </button>
            </div>
        </div>
    </div>

    <!-- Lista de Exámenes -->
    <div class="col-md-9 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-0">Exámenes de Laboratorio</h5>
                    <small class="text-muted" id="filtroActual">Mostrando todos los exámenes</small>
                </div>
                <button type="button" class="btn btn-primary" id="btnNuevoExamen">
                    <i class="fa-solid fa-plus me-1"></i> Nuevo Examen
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="tableExamenes">
                        <thead>
                            <tr>
                                <th>Código</th>
                                <th>Nombre del Examen</th>
                                <th>Categoría</th>
                                <th>Tipo Muestra</th>
                                <th>Tiempo Proc.</th>
                                <th>Precio</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="bodyExamenes">
                            <tr>
                                <td colspan="8" class="text-center">
                                    <i class="fa-solid fa-spinner fa-spin fa-2x text-muted my-4"></i>
                                    <p class="text-muted">Cargando exámenes...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Nueva Categoría -->
<div class="modal fade" id="modalNuevaCategoria" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Nueva Categoría de Exámenes</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="formNuevaCategoria">
                @csrf
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Nombre <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="nombre" required
                            placeholder="Ej: Hematología, Química Clínica">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Descripción</label>
                        <textarea class="form-control" name="descripcion" rows="2"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Orden</label>
                        <input type="number" class="form-control" name="orden" value="0" min="0">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Nuevo/Editar Examen -->
<div class="modal fade" id="modalExamen" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalExamenTitle">Nuevo Examen</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="formExamen">
                @csrf
                <input type="hidden" id="exam_id" name="exam_id">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Categoría <span class="text-danger">*</span></label>
                            <select class="form-select" name="category_id" id="category_id" required>
                                <option value="">Seleccione categoría</option>
                                @foreach($categories as $category)
                                <option value="{{ $category->id }}">{{ $category->nombre }}</option>
                                @endforeach
                            </select>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nombre del Examen <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="nombre" id="nombre" required
                                placeholder="Ej: Hemograma Completo">
                        </div>

                        <div class="col-12 mb-3">
                            <label class="form-label">Descripción</label>
                            <textarea class="form-control" name="descripcion" id="descripcion" rows="2"
                                placeholder="Descripción del examen"></textarea>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label class="form-label">Tipo de Muestra <span class="text-danger">*</span></label>
                            <select class="form-select" name="tipo_muestra" id="tipo_muestra" required>
                                <option value="Sangre">Sangre</option>
                                <option value="Orina">Orina</option>
                                <option value="Heces">Heces</option>
                                <option value="Saliva">Saliva</option>
                                <option value="Esputo">Esputo</option>
                                <option value="Otro">Otro</option>
                            </select>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label class="form-label">Tiempo Procesamiento <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="number" class="form-control" name="tiempo_procesamiento_horas" 
                                    id="tiempo_procesamiento_horas" required value="24" min="1">
                                <span class="input-group-text">horas</span>
                            </div>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label class="form-label">Precio <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" step="0.01" min="0" class="form-control" name="precio" 
                                    id="precio" required placeholder="0.00">
                            </div>
                        </div>

                        <div class="col-12 mb-3">
                            <label class="form-label">Preparación Requerida</label>
                            <textarea class="form-control" name="preparacion_requerida" id="preparacion_requerida" rows="2"
                                placeholder="Ej: Ayuno de 8 horas, No tomar medicamentos 24h antes"></textarea>
                        </div>

                        <div class="col-12 mb-3">
                            <label class="form-label">Valores de Referencia</label>
                            <textarea class="form-control" name="valores_referencia" id="valores_referencia" rows="2"
                                placeholder="Ej: Hombres: 4.5-5.5 millones/μL, Mujeres: 4.0-5.0 millones/μL"></textarea>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label class="form-label">Prioridad</label>
                            <select class="form-select" name="prioridad" id="prioridad">
                                <option value="normal" selected>Normal</option>
                                <option value="urgente">Urgente</option>
                                <option value="stat">STAT (Inmediato)</option>
                            </select>
                        </div>

                        <div class="col-md-4 mb-3">
                            <div class="form-check form-switch mt-4">
                                <input class="form-check-input" type="checkbox" id="requiere_ayuno" name="requiere_ayuno" value="1">
                                <label class="form-check-label" for="requiere_ayuno">Requiere Ayuno</label>
                            </div>
                        </div>

                        <div class="col-md-4 mb-3">
                            <div class="form-check form-switch mt-4">
                                <input class="form-check-input" type="checkbox" id="activo" name="activo" value="1" checked>
                                <label class="form-check-label" for="activo">Activo</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fa-solid fa-save me-1"></i>Guardar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@endsection

@section('page-script')
<script>
let categoriaSeleccionada = null;

$(document).ready(function() {
    cargarExamenes();

    // Botón nueva categoría
    $('#btnNuevaCategoria').on('click', function() {
        $('#modalNuevaCategoria').modal('show');
    });

    // Guardar nueva categoría
    $('#formNuevaCategoria').on('submit', function(e) {
        e.preventDefault();
        
        $.ajax({
            url: '/lab-categories/store',
            method: 'POST',
            data: $(this).serialize(),
            success: function(response) {
                if (response.success) {
                    $('#modalNuevaCategoria').modal('hide');
                    location.reload();
                }
            }
        });
    });

    // Filtrar por categoría
    $('.category-item').on('click', function() {
        $('.category-item').removeClass('active bg-light');
        $(this).addClass('active bg-light');
        
        categoriaSeleccionada = $(this).data('id');
        $('#filtroActual').text('Categoría: ' + $(this).text().trim());
        cargarExamenes();
    });

    // Ver todos
    $('#btnVerTodos').on('click', function() {
        $('.category-item').removeClass('active bg-light');
        categoriaSeleccionada = null;
        $('#filtroActual').text('Mostrando todos los exámenes');
        cargarExamenes();
    });

    // Nuevo examen
    $('#btnNuevoExamen').on('click', function() {
        $('#exam_id').val('');
        $('#modalExamenTitle').text('Nuevo Examen');
        $('#formExamen')[0].reset();
        $('#activo').prop('checked', true);
        $('#modalExamen').modal('show');
    });

    // Guardar examen
    $('#formExamen').on('submit', function(e) {
        e.preventDefault();
        
        const examId = $('#exam_id').val();
        const url = examId ? `/lab-exams/${examId}` : '/lab-exams/store';
        const method = examId ? 'PUT' : 'POST';
        
        $.ajax({
            url: url,
            method: method,
            data: $(this).serialize(),
            success: function(response) {
                if (response.success) {
                    $('#modalExamen').modal('hide');
                    Swal.fire({
                        icon: 'success',
                        title: '¡Éxito!',
                        text: response.message,
                        timer: 2000
                    });
                    cargarExamenes();
                }
            },
            error: function(xhr) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: xhr.responseJSON?.message || 'Error al guardar el examen'
                });
            }
        });
    });
});

function cargarExamenes() {
    let url = '/lab-exams/data';
    if (categoriaSeleccionada) {
        url += `?category_id=${categoriaSeleccionada}`;
    }

    $.ajax({
        url: url,
        method: 'GET',
        success: function(response) {
            let html = '';
            
            if (response.data && response.data.length > 0) {
                response.data.forEach(exam => {
                    html += `
                        <tr>
                            <td><code>${exam.codigo_examen}</code></td>
                            <td>
                                <strong>${exam.nombre}</strong>
                                ${exam.descripcion ? `<br><small class="text-muted">${exam.descripcion.substring(0, 60)}...</small>` : ''}
                            </td>
                            <td><span class="badge bg-label-primary">${exam.category.nombre}</span></td>
                            <td>${exam.tipo_muestra}</td>
                            <td>${exam.tiempo_procesamiento_horas}h</td>
                            <td><strong>$${parseFloat(exam.precio).toFixed(2)}</strong></td>
                            <td>
                                <span class="badge bg-label-${exam.activo ? 'success' : 'secondary'}">
                                    ${exam.activo ? 'Activo' : 'Inactivo'}
                                </span>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-sm btn-outline-info" onclick="verExamen(${exam.id})">
                                        <i class="fa-solid fa-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-warning" onclick="editarExamen(${exam.id})">
                                        <i class="fa-solid fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="eliminarExamen(${exam.id})">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
            } else {
                html = `
                    <tr>
                        <td colspan="8" class="text-center py-5">
                            <i class="fa-solid fa-flask fa-3x text-muted mb-3 d-block"></i>
                            <p class="text-muted">No hay exámenes registrados</p>
                            <button class="btn btn-primary btn-sm" id="btnNuevoExamenVacio">
                                <i class="fa-solid fa-plus me-1"></i>Crear Primer Examen
                            </button>
                        </td>
                    </tr>
                `;
            }
            
            $('#bodyExamenes').html(html);
        }
    });
}

function editarExamen(id) {
    $.ajax({
        url: `/lab-exams/${id}`,
        method: 'GET',
        success: function(exam) {
            $('#exam_id').val(exam.id);
            $('#modalExamenTitle').text('Editar Examen');
            $('#category_id').val(exam.category_id);
            $('#nombre').val(exam.nombre);
            $('#descripcion').val(exam.descripcion);
            $('#tipo_muestra').val(exam.tipo_muestra);
            $('#tiempo_procesamiento_horas').val(exam.tiempo_procesamiento_horas);
            $('#precio').val(exam.precio);
            $('#preparacion_requerida').val(exam.preparacion_requerida);
            $('#valores_referencia').val(exam.valores_referencia);
            $('#prioridad').val(exam.prioridad);
            $('#requiere_ayuno').prop('checked', exam.requiere_ayuno);
            $('#activo').prop('checked', exam.activo);
            $('#modalExamen').modal('show');
        }
    });
}

function verExamen(id) {
    $.ajax({
        url: `/lab-exams/${id}`,
        method: 'GET',
        success: function(exam) {
            Swal.fire({
                title: exam.nombre,
                html: `
                    <div class="text-start">
                        <p><strong>Código:</strong> ${exam.codigo_examen}</p>
                        <p><strong>Categoría:</strong> ${exam.category.nombre}</p>
                        <p><strong>Tipo de Muestra:</strong> ${exam.tipo_muestra}</p>
                        <p><strong>Tiempo de Procesamiento:</strong> ${exam.tiempo_procesamiento_horas} horas</p>
                        <p><strong>Precio:</strong> $${parseFloat(exam.precio).toFixed(2)}</p>
                        ${exam.requiere_ayuno ? '<p><strong class="text-warning">⚠️ Requiere Ayuno</strong></p>' : ''}
                        ${exam.preparacion_requerida ? `<p><strong>Preparación:</strong><br>${exam.preparacion_requerida}</p>` : ''}
                        ${exam.valores_referencia ? `<p><strong>Valores de Referencia:</strong><br>${exam.valores_referencia}</p>` : ''}
                    </div>
                `,
                width: 600,
                confirmButtonText: 'Cerrar'
            });
        }
    });
}

function eliminarExamen(id) {
    Swal.fire({
        title: '¿Eliminar examen?',
        text: 'Esta acción no se puede deshacer',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Sí, eliminar',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            $.ajax({
                url: `/lab-exams/${id}`,
                method: 'DELETE',
                headers: {
                    'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
                },
                success: function(response) {
                    if (response.success) {
                        Swal.fire('¡Eliminado!', response.message, 'success');
                        cargarExamenes();
                    }
                }
            });
        }
    });
}
</script>
@endsection

