@php
$configData = Helper::appClasses();
@endphp

@extends('layouts/layoutMaster')

@section('title', 'Nueva Orden de Laboratorio')

@section('vendor-style')
<link rel="stylesheet" href="{{asset('assets/vendor/libs/select2/select2.css')}}">
<style>
.exam-card {
    cursor: pointer;
    transition: all 0.2s;
    border: 2px solid #e0e0e0;
}
.exam-card:hover {
    border-color: #696cff;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.exam-card.selected {
    border-color: #696cff;
    background-color: #f5f5ff;
}
.exam-selected-badge {
    position: absolute;
    top: 10px;
    right: 10px;
}
</style>
@endsection

@section('vendor-script')
<script src="{{asset('assets/vendor/libs/select2/select2.js')}}"></script>
@endsection

@section('content')
<div class="row">
    <div class="col-12">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fa-solid fa-flask me-2"></i>Nueva Orden de Laboratorio</h5>
                <a href="/lab-orders" class="btn btn-sm btn-outline-secondary">
                    <i class="fa-solid fa-arrow-left me-1"></i>Volver a Órdenes
                </a>
            </div>
            <div class="card-body">
                <form id="formNuevaOrden" method="POST" action="{{ route('lab-orders.store') }}">
                    @csrf

                    @if($consultation)
                    <input type="hidden" name="consultation_id" value="{{ $consultation->id }}">
                    <div class="alert alert-info mb-4">
                        <i class="fa-solid fa-info-circle me-2"></i>
                        Orden generada desde consulta: <strong>{{ $consultation->numero_consulta }}</strong>
                    </div>
                    @endif

                    <!-- Información del Paciente -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary mb-3"><i class="fa-solid fa-user-injured me-2"></i>Información del Paciente</h6>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label" for="patient_id">Paciente <span class="text-danger">*</span></label>
                            <select class="form-select select2" id="patient_id" name="patient_id" required
                                @if($consultation) disabled @endif>
                                <option value="">Seleccione un paciente</option>
                                @foreach($patients as $patient)
                                <option value="{{ $patient->id }}"
                                    @if($consultation && $consultation->patient_id == $patient->id) selected @endif
                                    data-nombre="{{ $patient->nombre_completo }}"
                                    data-documento="{{ $patient->documento_identidad }}"
                                    data-telefono="{{ $patient->telefono }}">
                                    {{ $patient->nombre_completo }} - {{ $patient->documento_identidad }}
                                </option>
                                @endforeach
                            </select>
                            @if($consultation)
                            <input type="hidden" name="patient_id" value="{{ $consultation->patient_id }}">
                            @endif
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label" for="doctor_id">Médico Solicitante</label>
                            <select class="form-select select2" id="doctor_id" name="doctor_id"
                                @if($consultation) disabled @endif>
                                <option value="">Sin médico (orden externa)</option>
                                @foreach($doctors as $doctor)
                                <option value="{{ $doctor->id }}"
                                    @if($consultation && $consultation->doctor_id == $doctor->id) selected @endif>
                                    {{ $doctor->nombre_completo }} - {{ $doctor->especialidad }}
                                </option>
                                @endforeach
                            </select>
                            @if($consultation)
                            <input type="hidden" name="doctor_id" value="{{ $consultation->doctor_id }}">
                            @endif
                        </div>

                        <div class="col-md-4 mb-3">
                            <label class="form-label">Documento</label>
                            <input type="text" class="form-control bg-light" id="patient_documento" readonly>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label class="form-label">Teléfono</label>
                            <input type="text" class="form-control bg-light" id="patient_telefono" readonly>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label class="form-label" for="prioridad">Prioridad <span class="text-danger">*</span></label>
                            <select class="form-select" id="prioridad" name="prioridad" required>
                                <option value="normal" selected>Normal (72 horas)</option>
                                <option value="urgente">Urgente (12 horas)</option>
                                <option value="stat">STAT - Inmediato (2 horas)</option>
                            </select>
                        </div>
                    </div>

                    <!-- Selección de Exámenes -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-success mb-3"><i class="fa-solid fa-vial me-2"></i>Seleccionar Exámenes</h6>
                        </div>

                        <!-- Filtro por categoría -->
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Filtrar por Categoría</label>
                            <select class="form-select" id="filtroCategoria">
                                <option value="">Todas las categorías</option>
                                @foreach($exams->groupBy('category.nombre') as $categoryName => $categoryExams)
                                <option value="{{ $categoryName }}">{{ $categoryName }} ({{ $categoryExams->count() }})</option>
                                @endforeach
                            </select>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label class="form-label">Buscar Examen</label>
                            <input type="text" class="form-control" id="buscarExamen" placeholder="Buscar por nombre...">
                        </div>

                        <div class="col-md-4 mb-3">
                            <label class="form-label d-block">&nbsp;</label>
                            <button type="button" class="btn btn-outline-primary" id="btnLimpiarSeleccion">
                                <i class="fa-solid fa-times me-1"></i>Limpiar Selección
                            </button>
                        </div>

                        <!-- Lista de exámenes disponibles -->
                        <div class="col-12">
                            <div class="alert alert-info">
                                <i class="fa-solid fa-info-circle me-2"></i>
                                <strong>Exámenes Seleccionados: <span id="cantidadSeleccionados">0</span></strong> - 
                                Total: $<span id="totalSeleccionados">0.00</span>
                            </div>

                            <div class="row" id="listaExamenes">
                                @foreach($exams as $exam)
                                <div class="col-md-4 mb-3 exam-item" 
                                    data-id="{{ $exam->id }}"
                                    data-category="{{ $exam->category->nombre }}"
                                    data-nombre="{{ $exam->nombre }}">
                                    <div class="card exam-card h-100" onclick="toggleExamen({{ $exam->id }}, {{ $exam->precio }}, '{{ $exam->nombre }}')">
                                        <div class="card-body position-relative">
                                            <span class="exam-selected-badge badge bg-success d-none" id="badge-{{ $exam->id }}">
                                                <i class="fa-solid fa-check"></i>
                                            </span>
                                            <h6 class="card-title">{{ $exam->nombre }}</h6>
                                            @if($exam->requiere_ayuno)
                                            <span class="badge bg-label-warning mb-2">
                                                <i class="fa-solid fa-utensils-slash me-1"></i>Requiere Ayuno
                                            </span>
                                            @endif
                                            <p class="card-text small text-muted">
                                                <i class="fa-solid fa-vial me-1"></i>{{ $exam->tipo_muestra }}<br>
                                                <i class="fa-solid fa-clock me-1"></i>{{ $exam->tiempo_procesamiento_horas }}h
                                            </p>
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span class="badge bg-label-primary">{{ $exam->category->nombre }}</span>
                                                <strong class="text-primary">${{ number_format($exam->precio, 2) }}</strong>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                @endforeach
                            </div>

                            @if($exams->count() == 0)
                            <div class="text-center py-5">
                                <i class="fa-solid fa-flask fa-3x text-muted mb-3"></i>
                                <p class="text-muted">No hay exámenes disponibles</p>
                                <a href="/lab-exams" class="btn btn-primary">
                                    <i class="fa-solid fa-plus me-1"></i>Crear Exámenes
                                </a>
                            </div>
                            @endif
                        </div>
                    </div>

                    <!-- Indicaciones Especiales -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-info mb-3"><i class="fa-solid fa-notes-medical me-2"></i>Indicaciones Especiales</h6>
                        </div>

                        <div class="col-md-6 mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="requiere_ayuno" name="requiere_ayuno" value="1">
                                <label class="form-check-label" for="requiere_ayuno">
                                    <i class="fa-solid fa-utensils-slash me-1"></i>Requiere Ayuno
                                </label>
                            </div>
                        </div>

                        <div class="col-12 mb-3">
                            <label class="form-label" for="preparacion_requerida">Preparación del Paciente</label>
                            <textarea class="form-control" id="preparacion_requerida" name="preparacion_requerida" rows="2"
                                placeholder="Ej: Ayuno de 8 horas, suspender medicamentos, etc."></textarea>
                        </div>

                        <div class="col-12 mb-3">
                            <label class="form-label" for="indicaciones_especiales">Indicaciones Especiales</label>
                            <textarea class="form-control" id="indicaciones_especiales" name="indicaciones_especiales" rows="2"
                                placeholder="Indicaciones adicionales para el laboratorio"></textarea>
                        </div>
                    </div>

                    <!-- Exámenes seleccionados (hidden inputs) -->
                    <input type="hidden" id="examenes_seleccionados" name="exams" value="[]">

                    <div class="mt-4">
                        <button type="submit" class="btn btn-primary me-2" id="btnGuardarOrden">
                            <i class="fa-solid fa-save me-1"></i>Crear Orden
                        </button>
                        <button type="button" class="btn btn-success me-2" id="btnCrearYFacturar">
                            <i class="fa-solid fa-file-invoice me-1"></i>Crear y Facturar
                        </button>
                        <a href="/lab-orders" class="btn btn-outline-secondary">
                            <i class="fa-solid fa-times me-1"></i>Cancelar
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
@endsection

@section('page-script')
<script>
let examenesSeleccionados = [];

$(document).ready(function() {
    // Inicializar Select2
    $('.select2').select2({
        placeholder: 'Seleccione una opción',
        allowClear: true
    });

    // Mostrar info del paciente
    $('#patient_id').on('change', function() {
        const selected = $(this).find(':selected');
        $('#patient_documento').val(selected.data('documento') || '');
        $('#patient_telefono').val(selected.data('telefono') || '');
    });

    // Filtrar por categoría
    $('#filtroCategoria').on('change', function() {
        const categoria = $(this).val();
        filtrarExamenes(categoria, $('#buscarExamen').val());
    });

    // Buscar examen
    $('#buscarExamen').on('input', function() {
        const busqueda = $(this).val().toLowerCase();
        filtrarExamenes($('#filtroCategoria').val(), busqueda);
    });

    // Limpiar selección
    $('#btnLimpiarSeleccion').on('click', function() {
        examenesSeleccionados = [];
        $('.exam-card').removeClass('selected');
        $('.exam-selected-badge').addClass('d-none');
        actualizarResumen();
    });

    // Envío del formulario
    $('#formNuevaOrden').on('submit', function(e) {
        e.preventDefault();

        if (examenesSeleccionados.length === 0) {
            Swal.fire({
                icon: 'warning',
                title: 'Sin exámenes',
                text: 'Debe seleccionar al menos un examen'
            });
            return;
        }

        // Preparar datos
        $('#examenes_seleccionados').val(JSON.stringify(examenesSeleccionados));

        const formData = $(this).serialize();
        const submitBtn = $('#btnGuardarOrden');
        
        submitBtn.prop('disabled', true).html('<i class="fa-solid fa-spinner fa-spin me-1"></i>Creando...');

        $.ajax({
            url: $(this).attr('action'),
            method: 'POST',
            data: formData,
            success: function(response) {
                if (response.success) {
                    Swal.fire({
                        icon: 'success',
                        title: '¡Orden Creada!',
                        text: 'La orden de laboratorio ha sido creada correctamente',
                        confirmButtonText: 'Ver Órdenes'
                    }).then(() => {
                        window.location.href = '/lab-orders';
                    });
                }
            },
            error: function(xhr) {
                let errorMsg = 'Error al crear la orden';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMsg = xhr.responseJSON.message;
                }
                
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: errorMsg
                });
                
                submitBtn.prop('disabled', false).html('<i class="fa-solid fa-save me-1"></i>Crear Orden');
            }
        });
    });

    // Crear y facturar
    $('#btnCrearYFacturar').on('click', function() {
        if (examenesSeleccionados.length === 0) {
            Swal.fire({
                icon: 'warning',
                title: 'Sin exámenes',
                text: 'Debe seleccionar al menos un examen'
            });
            return;
        }

        if (confirm('¿Desea crear la orden y proceder a facturarla inmediatamente?')) {
            $('#formNuevaOrden').append('<input type="hidden" name="auto_facturar" value="1">');
            $('#formNuevaOrden').submit();
        }
    });
});

function toggleExamen(id, precio, nombre) {
    const index = examenesSeleccionados.indexOf(id);
    
    if (index > -1) {
        // Quitar examen
        examenesSeleccionados.splice(index, 1);
        $(`.exam-card`).parent().find(`[data-id="${id}"]`).find('.exam-card').removeClass('selected');
        $(`#badge-${id}`).addClass('d-none');
    } else {
        // Agregar examen
        examenesSeleccionados.push(id);
        $(`.exam-card`).parent().find(`[data-id="${id}"]`).find('.exam-card').addClass('selected');
        $(`#badge-${id}`).removeClass('d-none');
    }
    
    actualizarResumen();
}

function actualizarResumen() {
    $('#cantidadSeleccionados').text(examenesSeleccionados.length);
    
    // Calcular total
    let total = 0;
    examenesSeleccionados.forEach(id => {
        const card = $(`.exam-item[data-id="${id}"]`).find('.text-primary').text();
        const precio = parseFloat(card.replace('$', '').replace(',', ''));
        total += precio;
    });
    
    $('#totalSeleccionados').text(total.toFixed(2));
}

function filtrarExamenes(categoria, busqueda) {
    $('.exam-item').each(function() {
        const itemCategoria = $(this).data('category');
        const itemNombre = $(this).data('nombre').toLowerCase();
        
        let mostrar = true;
        
        if (categoria && itemCategoria !== categoria) {
            mostrar = false;
        }
        
        if (busqueda && !itemNombre.includes(busqueda)) {
            mostrar = false;
        }
        
        $(this).toggle(mostrar);
    });
}
</script>
@endsection

